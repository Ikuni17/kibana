name: Assign backport reviewer

on:
  pull_request_target:
    branches:
      - '8.19'
      - '9.*'
      - '[1-9][0-9]*.*'
    types:
      - opened

jobs:
  assign-reviewer:
    name: Assign team reviewer for manual backport
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.user.login != 'kibanamachine' &&
      contains(github.event.pull_request.labels.*.name, 'backport')
    steps:
      - name: Checkout workflow scripts
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          sparse-checkout: .github/workflows/scripts
          persist-credentials: false

      - name: Install dependencies
        run: npm install codeowners-utils
        working-directory: .github/workflows/scripts

      - name: Determine and assign team reviewer
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.KIBANAMACHINE_TOKEN }}
          script: |
            const script = require('./.github/workflows/scripts/assign_backport_reviewer.js');
            await script({ github, core, context });
